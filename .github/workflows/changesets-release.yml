name: Changesets Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          # This ensures we have the full history for changeset versioning
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Check for changesets
        id: check-changesets
        run: |
          # Check if there are any changesets to process
          if [ -n "$(ls -A .changeset/*.md 2>/dev/null | grep -v README.md | grep -v WORKFLOW.md)" ]; then
            echo "has_changesets=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Changesets detected"
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            echo "âœ… No changesets to process"
          fi

      - name: Create Version PR
        if: steps.check-changesets.outputs.has_changesets == 'true'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create a new branch for the version PR
          BRANCH_NAME="changeset-release/main"
          git checkout -b $BRANCH_NAME || git checkout $BRANCH_NAME

          # Run changeset version to bump versions and update changelog
          bun run changeset:version

          # Check if there are changes to commit
          if [ -n "$(git status --porcelain)" ]; then
            # Commit the changes
            git add .
            git commit -m "chore: version packages"

            # Push the branch
            git push -f origin $BRANCH_NAME

            # Create or update PR
            gh pr create \
              --base main \
              --head $BRANCH_NAME \
              --title "chore: version packages" \
              --body "This PR was automatically generated by the changesets workflow. Merging this PR will trigger the publish workflow." \
              || gh pr edit $BRANCH_NAME \
              --title "chore: version packages" \
              --body "This PR was automatically generated by the changesets workflow. Merging this PR will trigger the publish workflow."

            echo "âœ… Version PR created/updated"
          else
            echo "âœ… No version changes needed"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
